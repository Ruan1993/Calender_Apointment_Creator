<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini Nail Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc; /* Slate 50 */
        -webkit-tap-highlight-color: transparent;
      }
      /* Ensure the main container is limited and centered */
      #app {
        height: 100vh;
        max-width: 480px; /* Standard phone width */
        margin: 0 auto;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      /* Custom scrollbar for appointment list */
      .appointment-list-container::-webkit-scrollbar,
      .service-list-container::-webkit-scrollbar {
        width: 4px;
      }
      .appointment-list-container::-webkit-scrollbar-thumb,
      .service-list-container::-webkit-scrollbar-thumb {
        background-color: #94a3b8; /* Slate 400 */
        border-radius: 2px;
      }
      .appointment-list-container::-webkit-scrollbar-track,
      .service-list-container::-webkit-scrollbar-track {
        background-color: #e2e8f0; /* Slate 200 */
      }
      /* Main content padding adjustment for fixed nav */
      #main-content {
        padding-bottom: 5rem; /* Ensure space for the fixed nav (h-16 + some margin) */
      }

      /* Modal animation */
      .modal-bg-enter {
        opacity: 0;
      }
      .modal-bg-enter-active {
        opacity: 1;
        transition: opacity 200ms ease-out;
      }
      .modal-enter {
        transform: translateY(20px);
        opacity: 0;
      }
      .modal-enter-active {
        transform: translateY(0);
        opacity: 1;
        transition: all 300ms cubic-bezier(0.25, 0.8, 0.25, 1);
      }
    </style>
  </head>
  <body>
    <div id="app" class="flex flex-col bg-white">
      <header class="p-4 bg-indigo-600 text-white shadow-md flex-shrink-0">
        <h1 class="text-xl font-bold">Nail Appointment Pro</h1>
        <p class="text-sm opacity-80 mt-1">
          Service Management & Unlimited Booking
        </p>
        <p
          id="user-id-display"
          class="text-xs mt-1 bg-indigo-700 p-1 rounded-md overflow-hidden whitespace-nowrap overflow-ellipsis"
          title="Your unique User ID for data access."
        ></p>
      </header>

      <main class="flex-grow overflow-y-auto p-3" id="main-content">
        <div
          id="loading"
          class="flex flex-col items-center justify-center h-full text-indigo-500"
          style="min-height: 50vh"
        >
          <i class="fas fa-spinner fa-spin text-3xl"></i>
          <p class="mt-3 text-lg font-medium">Loading App and Database...</p>
        </div>
        <div id="calendar-view" class="hidden"></div>
        <div id="upcoming-view" class="hidden"></div>
        <div id="add-appointment-view" class="hidden"></div>
        <div id="service-management-view" class="hidden"></div>
      </main>

      <div
        id="message-box"
        class="fixed top-0 left-0 right-0 z-50 p-4 hidden"
        style="max-width: 480px; margin: 0 auto"
      ></div>

      <div
        id="confirm-modal"
        class="fixed inset-0 z-40 hidden"
        aria-modal="true"
        role="dialog"
      >
        <div
          class="absolute inset-0 bg-gray-900 bg-opacity-50 transition-opacity"
          id="confirm-modal-bg"
        ></div>
        <div
          class="fixed inset-0 overflow-y-auto"
          style="max-width: 480px; margin: 0 auto"
        >
          <div
            class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0"
          >
            <div
              class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
              id="confirm-modal-panel"
            >
              <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                  <div
                    class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"
                  >
                    <i
                      class="fas fa-exclamation-triangle text-red-600"
                      aria-hidden="true"
                    ></i>
                  </div>
                  <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                    <h3
                      class="text-lg font-semibold leading-6 text-gray-900"
                      id="confirm-modal-title"
                    >
                      Delete Item
                    </h3>
                    <div class="mt-2">
                      <p
                        class="text-sm text-gray-500"
                        id="confirm-modal-message"
                      >
                        Are you sure you want to delete this item? This action
                        cannot be undone.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
              <div
                class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6"
              >
                <button
                  type="button"
                  id="confirm-modal-ok"
                  class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto"
                >
                  Confirm Delete
                </button>
                <button
                  type="button"
                  id="confirm-modal-cancel"
                  class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <nav
        class="flex-shrink-0 bg-white border-t border-gray-200 shadow-2xl z-20"
      >
        <div class="flex justify-around items-center h-16">
          <button
            onclick="changeView('calendar')"
            id="nav-calendar"
            class="nav-button flex flex-col items-center text-indigo-600 hover:text-indigo-800 transition duration-150 p-2 w-1/4"
          >
            <i class="fas fa-calendar-alt text-xl"></i>
            <span class="text-xs font-medium">Calendar</span>
          </button>
          <button
            onclick="changeView('upcoming')"
            id="nav-upcoming"
            class="nav-button flex flex-col items-center text-gray-500 hover:text-indigo-800 transition duration-150 p-2 w-1/4"
          >
            <i class="fas fa-arrow-up-right-dots text-xl"></i>
            <span class="text-xs font-medium">Upcoming</span>
          </button>
          <button
            onclick="changeView('add')"
            id="nav-add"
            class="nav-button flex flex-col items-center text-gray-500 hover:text-indigo-800 transition duration-150 p-2 w-1/4"
          >
            <i class="fas fa-plus-circle text-xl"></i>
            <span class="text-xs font-medium">New Appt</span>
          </button>
          <button
            onclick="changeView('services')"
            id="nav-services"
            class="nav-button flex flex-col items-center text-gray-500 hover:text-indigo-800 transition duration-150 p-2 w-1/4"
          >
            <i class="fas fa-list-check text-xl"></i>
            <span class="text-xs font-medium">Services</span>
          </button>
        </div>
      </nav>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
        setPersistence,
        browserLocalPersistence,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
        collection,
        query,
        orderBy,
        where,
        serverTimestamp,
        deleteDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Global Firebase variables (Accessible via window scope)
      window.initializeApp = initializeApp;
      window.getAuth = getAuth;
      window.signInAnonymously = signInAnonymously;
      window.signInWithCustomToken = signInWithCustomToken;
      window.onAuthStateChanged = onAuthStateChanged;
      window.setPersistence = setPersistence;
      window.browserLocalPersistence = browserLocalPersistence;
      window.getFirestore = getFirestore;
      window.doc = doc;
      window.setDoc = setDoc;
      window.onSnapshot = onSnapshot;
      window.collection = collection;
      window.query = query;
      window.orderBy = orderBy;
      window.where = where;
      window.serverTimestamp = serverTimestamp;
      window.deleteDoc = deleteDoc;
      window.updateDoc = updateDoc;
      window.setLogLevel = setLogLevel;
    </script>

    <script type="module">
      setLogLevel("Debug"); // Enable Firestore logging

      // ------------------------------------------------------------------
      // ðŸ‘‡ HARDCODED CONFIGURATION TO GUARANTEE KEY LOADING - FIXES ERROR ðŸ‘‡
      // ------------------------------------------------------------------
      const appId = "calender-appointment-creator"; // Project ID

      const FIREBASE_CONFIG_OBJECT = {
        apiKey: "AIzaSyB0wD7gK-0rgFkR1D7OtbzIT8",
        authDomain: "calender-appointment-creator.firebaseapp.com",
        projectId: "calender-appointment-creator",
        storageBucket: "calender-appointment-creator.appspot.com",
        messagingSenderId: "976887592733",
        appId: "1:976887592733:web:97ee6118678c01138993f4",
        measurementId: "G-X84XF3B1KZ",
      };

      const firebaseConfig = FIREBASE_CONFIG_OBJECT;
      const initialAuthToken = null;
      // ------------------------------------------------------------------

      let db, auth;
      let userId = "unknown";

      // Global data state
      window.state = {
        currentMonth: new Date(),
        selectedDate: new Date(),
        calendarMode: "month",
        appointments: [],
        services: [],
        currentView: "calendar",
        isAuthReady: false,
      };

      /** Utility Functions **/

      const months = [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December",
      ];
      const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

      function formatDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        return `${y}-${m}-${d}`;
      }

      function addDays(date, days) {
        const d = new Date(date);
        d.setDate(d.getDate() + days);
        return d;
      }

      function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay(); // 0 (Sunday) to 6 (Saturday)
        const diff = d.getDate() - day; // adjust date to Sunday
        return new Date(d.getFullYear(), d.getMonth(), diff);
      }

      function displayMessage(message, type = "success", duration = 3000) {
        const box = document.getElementById("message-box");
        box.innerHTML = `<div class="rounded-lg p-3 text-sm text-white shadow-lg ${
          type === "error" ? "bg-red-500" : "bg-green-500"
        }">
                ${message}
            </div>`;
        box.classList.remove("hidden");
        setTimeout(() => box.classList.add("hidden"), duration);
      }

      /**
       * Custom Confirmation Modal (Replaces alert/confirm)
       */
      function showConfirmModal(title, message) {
        return new Promise((resolve) => {
          const modal = document.getElementById("confirm-modal");
          const titleEl = document.getElementById("confirm-modal-title");
          const messageEl = document.getElementById("confirm-modal-message");
          const okBtn = document.getElementById("confirm-modal-ok");
          const cancelBtn = document.getElementById("confirm-modal-cancel");

          titleEl.textContent = title;
          messageEl.textContent = message;

          // Animation classes setup
          const bg = document.getElementById("confirm-modal-bg");
          const panel = document.getElementById("confirm-modal-panel");

          function hideModal(result) {
            bg.classList.remove("modal-bg-enter-active");
            bg.classList.add("modal-bg-enter");
            panel.classList.remove("modal-enter-active");
            panel.classList.add("modal-enter");

            setTimeout(() => {
              modal.classList.add("hidden");
              okBtn.removeEventListener("click", onOk);
              cancelBtn.removeEventListener("click", onCancel);
              resolve(result);
            }, 300); // Wait for transition
          }

          function onOk() {
            hideModal(true);
          }
          function onCancel() {
            hideModal(false);
          }

          okBtn.onclick = onOk;
          cancelBtn.onclick = onCancel;

          // Show modal with animation
          modal.classList.remove("hidden");
          setTimeout(() => {
            bg.classList.add("modal-bg-enter-active");
            bg.classList.remove("modal-bg-enter");
            panel.classList.add("modal-enter-active");
            panel.classList.remove("modal-enter");
          }, 10);
        });
      }
      window.showConfirmModal = showConfirmModal;

      function showLoading(show) {
        document.getElementById("loading").classList.toggle("hidden", !show);
        document
          .getElementById("calendar-view")
          .classList.toggle("hidden", show);
        document
          .getElementById("add-appointment-view")
          .classList.toggle("hidden", show);
        document
          .getElementById("service-management-view")
          .classList.toggle("hidden", show);
      }

      /** Firebase & Auth Initialization **/

      async function initApp() {
        if (!firebaseConfig) {
          // This should never happen with the hardcoded fix, but is a safe fallback
          console.error("Firebase config is missing.");
          showLoading(false);
          displayMessage(
            "Error: Firebase configuration missing.",
            "error",
            5000
          );
          return;
        }

        try {
          const app = initializeApp(firebaseConfig);
          const { getAuth } = window; // Use imported functions
          const { getFirestore } = window; // Use imported functions
          const {
            setPersistence,
            browserLocalPersistence,
            signInAnonymously,
            onAuthStateChanged,
          } = window;

          db = getFirestore(app);
          auth = getAuth(app);

          await setPersistence(auth, browserLocalPersistence).catch((e) => {
            console.warn("Persistence failed, continuing without it:", e);
          });

          // 1. Sign in
          if (initialAuthToken) {
            await window.signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }

          // 2. Auth State Listener
          onAuthStateChanged(auth, (user) => {
            if (user) {
              userId = user.uid;
              window.state.isAuthReady = true;
              document.getElementById(
                "user-id-display"
              ).textContent = `User ID: ${userId}`;
              console.log("Authenticated with UID:", userId);

              // Start real-time data listeners after auth is ready
              listenForAppointments();
              listenForServices(); // NEW Listener
              render();
            } else {
              console.log("Not authenticated.");
              userId = crypto.randomUUID();
              window.state.isAuthReady = true;
              document.getElementById(
                "user-id-display"
              ).textContent = `User ID: ${userId} (Anon)`;
              listenForAppointments();
              listenForServices(); // NEW Listener
              render();
            }
            showLoading(false);
          });
        } catch (error) {
          console.error("Firebase initialization or sign-in failed:", error);
          displayMessage(`Auth Error: ${error.message}`, "error", 10000);
          showLoading(false);
        }
      }

      /** Firestore Logic - Appointments **/

      function getAppointmentsRef() {
        if (!db || !userId) {
          console.error("Database or User ID not ready for appointments.");
          return null;
        }
        // Private data path: /artifacts/{appId}/users/{userId}/appointments
        return window.collection(
          db,
          `artifacts/${appId}/users/${userId}/appointments`
        );
      }

      function listenForAppointments() {
        const appointmentsRef = getAppointmentsRef();
        if (!appointmentsRef) return;

        const q = window.query(appointmentsRef);

        window.onSnapshot(
          q,
          (snapshot) => {
            let fetchedAppointments = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            // Sort in memory by date and then time for display
            fetchedAppointments.sort((a, b) => {
              const dateTimeA = new Date(`${a.date}T${a.time || "00:00"}`);
              const dateTimeB = new Date(`${b.date}T${b.time || "00:00"}`);
              return dateTimeA - dateTimeB;
            });

            window.state.appointments = fetchedAppointments;
            console.log(
              "Appointments updated:",
              window.state.appointments.length
            );
            renderCalendarView();
            renderUpcomingView();
          },
          (error) => {
            console.error("Error listening to appointments:", error);
            displayMessage(
              "Error fetching appointment data: " + error.message,
              "error",
              5000
            );
          }
        );
      }

      async function saveAppointment(event) {
        event.preventDefault();
        const form = event.target;
        const appointmentsRef = getAppointmentsRef();
        if (!appointmentsRef) return;

        const selectedServiceCheckboxes = Array.from(
          form.querySelectorAll('input[name="serviceId"]:checked')
        );

        if (selectedServiceCheckboxes.length === 0) {
          displayMessage(
            "Please select at least one service before saving.",
            "error"
          );
          return;
        }

        let totalDuration = 0;
        const serviceDetails = [];
        const serviceNames = [];

        selectedServiceCheckboxes.forEach((checkbox) => {
          const serviceId = checkbox.value;
          const service = window.state.services.find((s) => s.id === serviceId);
          if (service) {
            totalDuration += service.duration;
            serviceDetails.push({
              id: service.id,
              name: service.name,
              duration: service.duration,
            });
            serviceNames.push(service.name);
          }
        });

        const newAppointment = {
          clientName: form.clientName.value.trim(),
          service: serviceNames.join(", "), // New: Comma-separated string of names
          serviceDetails: serviceDetails, // New: Array of selected service objects
          date: form.date.value,
          time: form.time.value,
          duration: totalDuration, // New: Sum of all selected services
          notes: form.notes.value.trim(),
          timestamp: window.serverTimestamp(),
        };

        try {
          if (
            !newAppointment.date ||
            !newAppointment.time ||
            !newAppointment.clientName
          ) {
            displayMessage(
              "Please fill out all required fields (Client, Date, Time, Service).",
              "error"
            );
            return;
          }

          await window.setDoc(window.doc(appointmentsRef), newAppointment);

          // Reset form and switch view
          form.reset();
          displayMessage(
            `Appointment for ${newAppointment.clientName} (${newAppointment.service}) saved successfully!`
          );
          changeView("upcoming");
        } catch (error) {
          console.error("Error saving appointment:", error);
          displayMessage(
            "Failed to save appointment: " + error.message,
            "error",
            5000
          );
        }
      }
      window.saveAppointment = saveAppointment;

      async function deleteAppointment(id) {
        const appointmentsRef = getAppointmentsRef();
        if (!appointmentsRef) return;

        const confirmed = await showConfirmModal(
          "Confirm Deletion",
          "Are you sure you want to delete this appointment? This action cannot be undone."
        );
        if (!confirmed) return;

        try {
          const docRef = window.doc(appointmentsRef, id);
          await window.deleteDoc(docRef);
          displayMessage("Appointment deleted successfully.");
        } catch (error) {
          console.error("Error deleting appointment:", error);
          displayMessage(
            "Failed to delete appointment: " + error.message,
            "error",
            5000
          );
        }
      }
      window.deleteAppointment = deleteAppointment;

      /** Firestore Logic - Services **/

      function getServicesRef() {
        if (!db || !userId) {
          console.error("Database or User ID not ready for services.");
          return null;
        }
        // Private data path: /artifacts/{appId}/users/{userId}/services
        return window.collection(
          db,
          `artifacts/${appId}/users/${userId}/services`
        );
      }

      function listenForServices() {
        const servicesRef = getServicesRef();
        if (!servicesRef) return;

        const q = window.query(servicesRef, window.orderBy("name", "asc"));

        window.onSnapshot(
          q,
          (snapshot) => {
            window.state.services = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            console.log("Services updated:", window.state.services.length);
            // Re-render views that depend on services
            if (window.state.currentView === "services") {
              renderServiceManagementView();
            } else if (window.state.currentView === "add") {
              // Re-render add view to update the service dropdown options
              renderAddAppointmentView();
            }
          },
          (error) => {
            console.error("Error listening to services:", error);
            displayMessage(
              "Error fetching service data: " + error.message,
              "error",
              5000
            );
          }
        );
      }

      async function saveService(event) {
        event.preventDefault();
        const form = document.getElementById("service-form");
        const servicesRef = getServicesRef();
        if (!servicesRef) return;

        const serviceName = form.serviceName.value.trim();
        const serviceDuration = parseInt(form.serviceDuration.value);
        const serviceId = form.dataset.editingId;

        if (!serviceName || serviceDuration <= 0) {
          displayMessage(
            "Please provide a valid name and duration (min 5 minutes).",
            "error"
          );
          return;
        }

        const serviceData = {
          name: serviceName,
          duration: serviceDuration,
          timestamp: window.serverTimestamp(),
        };

        try {
          if (serviceId) {
            await window.updateDoc(
              window.doc(servicesRef, serviceId),
              serviceData
            );
            displayMessage(`Service "${serviceName}" updated successfully!`);
          } else {
            await window.setDoc(window.doc(servicesRef), serviceData);
            displayMessage(`Service "${serviceName}" added successfully!`);
          }

          // Reset form state
          form.reset();
          delete form.dataset.editingId;
          document.getElementById("service-form-title").textContent =
            "Add New Service";
          document.getElementById("service-submit-btn").textContent =
            "Save Service";
          const cancelButton = document.getElementById("service-cancel-edit");
          if (cancelButton) cancelButton.classList.add("hidden");
        } catch (error) {
          console.error("Error saving service:", error);
          displayMessage(
            "Failed to save service: " + error.message,
            "error",
            5000
          );
        }
      }
      window.saveService = saveService;

      async function deleteService(id, name) {
        const confirmed = await showConfirmModal(
          "Confirm Service Deletion",
          `Are you sure you want to delete the service: ${name}? All appointments referencing this service will still exist but will show "Service N/A".`
        );
        if (!confirmed) return;

        const servicesRef = getServicesRef();
        if (!servicesRef) return;

        try {
          await window.deleteDoc(window.doc(servicesRef, id));
          displayMessage(`Service "${name}" deleted.`);
        } catch (error) {
          console.error("Error deleting service:", error);
          displayMessage(
            "Failed to delete service: " + error.message,
            "error",
            5000
          );
        }
      }
      window.deleteService = deleteService;

      function editService(id, name, duration) {
        const form = document.getElementById("service-form");
        form.serviceName.value = name;
        form.serviceDuration.value = duration;
        form.dataset.editingId = id;
        document.getElementById("service-form-title").textContent =
          "Edit Service";
        document.getElementById("service-submit-btn").textContent =
          "Update Service";
        const cancelButton = document.getElementById("service-cancel-edit");
        if (cancelButton) cancelButton.classList.remove("hidden");
        // Scroll to the top of the form for better mobile UX
        form.scrollIntoView({ behavior: "smooth", block: "start" });
        form.serviceName.focus();
      }
      window.editService = editService;

      function cancelEditService() {
        const form = document.getElementById("service-form");
        form.reset();
        delete form.dataset.editingId;
        document.getElementById("service-form-title").textContent =
          "Add New Service";
        document.getElementById("service-submit-btn").textContent =
          "Save Service";
        const cancelButton = document.getElementById("service-cancel-edit");
        if (cancelButton) cancelButton.classList.add("hidden");
      }
      window.cancelEditService = cancelEditService;

      /** Dynamic UI Logic **/

      /**
       * NEW: Calculates the sum of durations of all checked services
       */
      function updateAppointmentDuration() {
        const serviceCheckboxes = document.querySelectorAll(
          'input[name="serviceId"]'
        );
        const durationInput = document.getElementById("duration");
        let totalDuration = 0;

        serviceCheckboxes.forEach((checkbox) => {
          if (checkbox.checked) {
            const serviceId = checkbox.value;
            const service = window.state.services.find(
              (s) => s.id === serviceId
            );
            if (service) {
              totalDuration += service.duration;
            }
          }
        });

        durationInput.value = totalDuration > 0 ? totalDuration : 30; // Min 30 min default if none selected
      }
      window.updateAppointmentDuration = updateAppointmentDuration;

      /** Rendering Functions **/

      function render() {
        document.getElementById("calendar-view").classList.add("hidden");
        document.getElementById("upcoming-view").classList.add("hidden");
        document.getElementById("add-appointment-view").classList.add("hidden");
        document
          .getElementById("service-management-view")
          .classList.add("hidden");

        switch (window.state.currentView) {
          case "calendar":
            document.getElementById("calendar-view").classList.remove("hidden");
            renderCalendarView();
            break;
          case "upcoming":
            document.getElementById("upcoming-view").classList.remove("hidden");
            renderUpcomingView();
            break;
          case "add":
            document
              .getElementById("add-appointment-view")
              .classList.remove("hidden");
            renderAddAppointmentView();
            break;
          case "services":
            document
              .getElementById("service-management-view")
              .classList.remove("hidden");
            renderServiceManagementView();
            break;
        }
        updateNavBar();
      }
      window.render = render;

      function updateNavBar() {
        document.querySelectorAll(".nav-button").forEach((btn) => {
          btn.classList.remove("text-indigo-600");
          btn.classList.add("text-gray-500");
        });

        let activeId = "";
        if (window.state.currentView === "calendar") activeId = "nav-calendar";
        else if (window.state.currentView === "upcoming")
          activeId = "nav-upcoming";
        else if (window.state.currentView === "add") activeId = "nav-add";
        else if (window.state.currentView === "services")
          activeId = "nav-services";

        const activeBtn = document.getElementById(activeId);
        if (activeBtn) {
          activeBtn.classList.add("text-indigo-600");
          activeBtn.classList.remove("text-gray-500");
        }
      }

      function changeView(view) {
        window.state.currentView = view;
        render();
      }
      window.changeView = changeView;

      // --- Calendar Mode Functions ---

      function changeMonth(delta) {
        window.state.currentMonth.setMonth(
          window.state.currentMonth.getMonth() + delta
        );
        window.state.currentMonth = new Date(window.state.currentMonth);
        renderCalendarView();
      }
      window.changeMonth = changeMonth;

      function changeSelectedDate(delta) {
        window.state.selectedDate = addDays(window.state.selectedDate, delta);
        // Also update currentMonth to follow the selectedDate, helpful for day/week mode
        window.state.currentMonth = new Date(
          window.state.selectedDate.getFullYear(),
          window.state.selectedDate.getMonth(),
          1
        );
        renderCalendarView();
      }
      window.changeSelectedDate = changeSelectedDate;

      function selectDate(day) {
        window.state.selectedDate = new Date(
          window.state.currentMonth.getFullYear(),
          window.state.currentMonth.getMonth(),
          day
        );
        // Switch to day view when a specific day is clicked on the month calendar
        window.state.calendarMode = "day";
        renderCalendarView();
      }
      window.selectDate = selectDate;

      function setCalendarMode(mode) {
        window.state.calendarMode = mode;
        // When switching back to week/month, ensure selectedDate is included in the view
        if (mode === "month") {
          window.state.currentMonth = new Date(
            window.state.selectedDate.getFullYear(),
            window.state.selectedDate.getMonth(),
            1
          );
        }
        renderCalendarView();
      }
      window.setCalendarMode = setCalendarMode;

      // --- Appointment List Helper ---

      /**
       * Generates the HTML list of appointments for a specific day.
       * @param {string} dayKey - The date string 'YYYY-MM-DD'.
       * @param {string} displayTitle - The title for the section (e.g., 'Monday, Nov 13').
       * @param {boolean} isCompact - Use compact rendering for week view.
       */
      function generateDayAppointmentListHTML(
        dayKey,
        displayTitle,
        isCompact = false
      ) {
        const appts = window.state.appointments.filter(
          (appt) => appt.date === dayKey
        );

        let listHTML = `
                <div class="mt-8">
                    <h3 class="${
                      isCompact ? "text-lg" : "text-xl"
                    } font-bold text-gray-800 mb-3 border-b pb-2">${displayTitle}</h3>
                    <div class="appointment-list-container ${
                      isCompact ? "max-h-full" : "max-h-[30vh]"
                    } overflow-y-auto pr-2">
            `;

        if (appts.length === 0) {
          listHTML += `
                    <div class="text-center py-5 bg-gray-50 rounded-xl border border-dashed border-gray-200">
                        <i class="fas fa-calendar-check text-2xl text-gray-300"></i>
                        <p class="mt-1 text-sm text-gray-600">No appointments.</p>
                    </div>
                `;
        } else {
          appts.forEach((appt) => {
            // Determine service name display: use the new multi-service string, or fallback to old single service name
            const serviceDisplay = appt.service || "Service N/A";

            listHTML += `
                        <div class="bg-white p-3 mb-2 rounded-xl shadow-lg border border-indigo-100 flex justify-between items-start">
                            <div class="flex-grow">
                                <p class="text-xs font-semibold uppercase text-indigo-500">${serviceDisplay}</p>
                                <h4 class="text-base font-bold text-gray-900">${
                                  appt.clientName
                                }</h4>
                                <div class="text-xs text-gray-600 mt-1">
                                    <p><i class="fas fa-clock w-3 text-center text-indigo-400"></i> <span class="ml-1">${
                                      appt.time
                                    } (${appt.duration || 30} min)</span></p>
                                    ${
                                      appt.notes && !isCompact
                                        ? `<p class="mt-1 text-xs italic text-gray-500"><i class="fas fa-sticky-note w-3 text-center"></i> ${appt.notes}</p>`
                                        : ""
                                    }
                                </div>
                            </div>
                            <button onclick="deleteAppointment('${
                              appt.id
                            }')" class="text-red-400 hover:text-red-600 transition p-1 ml-2 focus:outline-none" title="Delete Appointment">
                                <i class="fas fa-trash-alt text-base"></i>
                            </button>
                        </div>
                    `;
          });
        }

        listHTML += `</div></div>`;
        return listHTML;
      }

      // --- View Renderers ---

      function renderCalendarView() {
        const container = document.getElementById("calendar-view");
        if (container.classList.contains("hidden")) return;

        const mode = window.state.calendarMode;

        const modeSelectorHTML = `
            <div class="flex justify-center space-x-2 mb-4 bg-gray-100 p-1 rounded-xl shadow-inner border border-gray-200">
                <button onclick="setCalendarMode('day')" class="flex-1 py-2 text-sm font-semibold rounded-lg transition ${
                  mode === "day"
                    ? "bg-indigo-600 text-white shadow"
                    : "text-gray-700 hover:bg-white"
                }">Day</button>
                <button onclick="setCalendarMode('week')" class="flex-1 py-2 text-sm font-semibold rounded-lg transition ${
                  mode === "week"
                    ? "bg-indigo-600 text-white shadow"
                    : "text-gray-700 hover:bg-white"
                }">Week</button>
                <button onclick="setCalendarMode('month')" class="flex-1 py-2 text-sm font-semibold rounded-lg transition ${
                  mode === "month"
                    ? "bg-indigo-600 text-white shadow"
                    : "text-gray-700 hover:bg-white"
                }">Month</button>
            </div>
        `;

        container.innerHTML = modeSelectorHTML;

        switch (mode) {
          case "day":
            container.innerHTML += renderDayView();
            break;
          case "week":
            container.innerHTML += renderWeekView();
            break;
          case "month":
          default:
            container.innerHTML += renderMonthView();
            break;
        }
      }

      function renderDayView() {
        const selectedDate = window.state.selectedDate;
        const dayKey = formatDate(selectedDate);
        const selectedDateDisplay = selectedDate.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        // Navigation for Day View
        const navHTML = `
              <div class="mb-4 flex justify-between items-center px-2">
                  <button onclick="changeSelectedDate(-1)" class="p-2 text-indigo-600 hover:bg-indigo-100 rounded-full transition"><i class="fas fa-chevron-left"></i></button>
                  <h2 class="text-xl font-semibold text-gray-800 text-center">${selectedDateDisplay}</h2>
                  <button onclick="changeSelectedDate(1)" class="p-2 text-indigo-600 hover:bg-indigo-100 rounded-full transition"><i class="fas fa-chevron-right"></i></button>
              </div>
          `;

        return (
          navHTML +
          generateDayAppointmentListHTML(dayKey, "Appointments", false)
        );
      }

      function renderWeekView() {
        const selectedDate = window.state.selectedDate;
        const startOfWeek = getStartOfWeek(selectedDate);

        // Week navigation: change by 7 days
        const weekEnd = addDays(startOfWeek, 6);
        const weekStartDisplay = startOfWeek.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
        const weekEndDisplay = weekEnd.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });

        const navHTML = `
              <div class="mb-4 flex justify-between items-center px-2">
                  <button onclick="changeSelectedDate(-7)" class="p-2 text-indigo-600 hover:bg-indigo-100 rounded-full transition"><i class="fas fa-chevron-left"></i></button>
                  <h2 class="text-xl font-semibold text-gray-800">${weekStartDisplay} - ${weekEndDisplay}</h2>
                  <button onclick="changeSelectedDate(7)" class="p-2 text-indigo-600 hover:bg-indigo-100 rounded-full transition"><i class="fas fa-chevron-right"></i></button>
              </div>
          `;

        let weekCalendarHTML = `<div class="grid grid-cols-7 text-center text-sm font-medium text-gray-500 border-b pb-2 mb-2">`;
        let weekApptListHTML = `<div class="space-y-4">`;
        const selectedDayKey = formatDate(selectedDate);

        for (let i = 0; i < 7; i++) {
          const day = addDays(startOfWeek, i);
          const dayKey = formatDate(day);
          const isSelected = dayKey === selectedDayKey;
          const apptsForDay = window.state.appointments.filter(
            (appt) => appt.date === dayKey
          );
          const apptCount = apptsForDay.length;
          const dayOfWeek = daysOfWeek[day.getDay()];

          // Day Headers (clickable to select the day and show its list)
          weekCalendarHTML += `
                  <div onclick="changeSelectedDate(${
                    i - (selectedDate.getDay() - startOfWeek.getDay())
                  })" 
                       class="p-1 cursor-pointer ${
                         isSelected
                           ? "bg-indigo-600 text-white rounded-lg shadow"
                           : "text-gray-800 hover:bg-gray-100 rounded-lg"
                       }">
                      <span class="text-xs block">${dayOfWeek}</span>
                      <span class="text-lg font-bold block">${day.getDate()}</span>
                      ${
                        apptCount > 0
                          ? `<span class="block text-xs leading-none mt-0.5 w-1.5 h-1.5 rounded-full mx-auto ${
                              isSelected ? "bg-white" : "bg-green-500"
                            }"></span>`
                          : ""
                      }
                  </div>
              `;

          // Appointment List for the selected day only
          if (isSelected) {
            weekApptListHTML += generateDayAppointmentListHTML(
              dayKey,
              day.toLocaleDateString("en-US", {
                weekday: "long",
                month: "long",
                day: "numeric",
              }),
              false
            );
          }
        }

        weekCalendarHTML += `</div>`;
        weekApptListHTML += `</div>`;

        return navHTML + weekCalendarHTML + weekApptListHTML;
      }

      function renderMonthView() {
        const currentDate = window.state.currentMonth;
        const today = new Date();
        const selectedDayKey = formatDate(window.state.selectedDate);

        const monthName = months[currentDate.getMonth()];
        const year = currentDate.getFullYear();

        const firstDayOfMonth = new Date(
          year,
          currentDate.getMonth(),
          1
        ).getDay();
        const daysInMonth = new Date(
          year,
          currentDate.getMonth() + 1,
          0
        ).getDate();
        const daysInPrevMonth = new Date(
          year,
          currentDate.getMonth(),
          0
        ).getDate();

        const appointmentsByDay = window.state.appointments.reduce(
          (acc, appt) => {
            acc[appt.date] = acc[appt.date] || [];
            acc[appt.date].push(appt);
            return acc;
          },
          {}
        );

        let calendarHTML = `
                <div class="mb-4 flex justify-between items-center px-2">
                    <button onclick="changeMonth(-1)" class="p-2 text-indigo-600 hover:bg-indigo-100 rounded-full transition"><i class="fas fa-chevron-left"></i></button>
                    <h2 class="text-2xl font-semibold text-gray-800">${monthName} ${year}</h2>
                    <button onclick="changeMonth(1)" class="p-2 text-indigo-600 hover:bg-indigo-100 rounded-full transition"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="grid grid-cols-7 text-center text-sm font-medium text-gray-500 border-b pb-2">
                    ${daysOfWeek.map((day) => `<span>${day}</span>`).join("")}
                </div>

                <div class="grid grid-cols-7 gap-1 mt-2">
            `;

        let dayCounter = 1;
        let currentDayDate;

        // Previous month's days (for padding)
        for (let i = 0; i < firstDayOfMonth; i++) {
          const prevDay = daysInPrevMonth - firstDayOfMonth + i + 1;
          calendarHTML += `<div class="text-center p-2 text-gray-300 font-medium">${prevDay}</div>`;
        }

        // Current month's days
        for (let i = 1; i <= daysInMonth; i++) {
          currentDayDate = new Date(year, currentDate.getMonth(), i);
          const dayKey = formatDate(currentDayDate);
          const isToday = dayKey === formatDate(today);
          const isSelected = dayKey === selectedDayKey;
          const apptCount = (appointmentsByDay[dayKey] || []).length;

          let classes =
            "p-1 h-12 flex flex-col items-center justify-center rounded-xl font-medium cursor-pointer transition transform";

          if (isSelected) {
            classes +=
              " bg-indigo-600 text-white shadow-lg ring-2 ring-indigo-300 scale-105";
          } else if (isToday) {
            classes += " bg-indigo-100 text-indigo-700 hover:bg-indigo-200";
          } else {
            classes += " text-gray-800 hover:bg-gray-100";
          }

          calendarHTML += `
                    <div onclick="selectDate(${i})" class="${classes}" role="button" aria-pressed="${isSelected}">
                        <span class="text-lg leading-none">${i}</span>
                        ${
                          apptCount > 0
                            ? `<span class="text-xs leading-none mt-0.5 w-1.5 h-1.5 rounded-full mx-auto ${
                                isSelected ? "bg-white" : "bg-green-500"
                              }"></span>`
                            : ""
                        }
                    </div>
                `;
          dayCounter++;
        }

        // Next month's days (for padding)
        while ((dayCounter - 1) % 7 !== 0) {
          calendarHTML += `<div class="text-center p-2 text-gray-300 font-medium">${
            dayCounter - firstDayOfMonth - daysInMonth
          }</div>`;
          dayCounter++;
        }

        calendarHTML += "</div>";

        const selectedDateDisplay =
          window.state.selectedDate.toLocaleDateString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });

        return (
          calendarHTML +
          generateDayAppointmentListHTML(
            selectedDayKey,
            `Appointments for ${selectedDateDisplay}`,
            false
          )
        );
      }

      function renderUpcomingView() {
        const container = document.getElementById("upcoming-view");
        if (container.classList.contains("hidden")) return;

        const todayKey = formatDate(new Date());

        // Filter for appointments today or in the future
        const upcomingAppts = window.state.appointments.filter((appt) => {
          return appt.date >= todayKey;
        });

        let listHTML = `
              <h2 class="text-2xl font-bold text-gray-800 mb-6">Upcoming Appointments</h2>
              <div class="space-y-4 appointment-list-container max-h-[80vh] overflow-y-auto">
          `;

        if (upcomingAppts.length === 0) {
          listHTML += `
              <div class="text-center py-10 bg-gray-50 rounded-xl border border-dashed border-gray-200">
                  <i class="fas fa-calendar-alt text-4xl text-gray-300"></i>
                  <p class="mt-3 text-gray-600">No appointments scheduled for the future.</p>
                  <button onclick="changeView('add')" class="mt-4 text-indigo-600 font-medium hover:text-indigo-700">
                      Book a new appointment <i class="fas fa-arrow-right ml-1"></i>
                  </button>
              </div>
          `;
        } else {
          upcomingAppts.forEach((appt) => {
            const dateDisplay = new Date(
              `${appt.date}T${appt.time || "00:00"}`
            ).toLocaleDateString("en-US", {
              weekday: "short",
              month: "short",
              day: "numeric",
              year: "numeric",
            });

            listHTML += `
                  <div class="bg-white p-4 rounded-xl shadow-lg border border-indigo-100 flex justify-between items-start">
                      <div class="flex-grow">
                          <p class="text-xs font-semibold uppercase text-indigo-500">${
                            appt.service || "Service N/A"
                          }</p>
                          <h4 class="text-lg font-bold text-gray-900">${
                            appt.clientName
                          }</h4>
                          <div class="text-sm text-gray-600 mt-1 space-y-0.5">
                              <p><i class="fas fa-calendar-day w-4 text-center text-indigo-400"></i> <span class="ml-1 font-medium">${dateDisplay}</span></p>
                              <p><i class="fas fa-clock w-4 text-center text-indigo-400"></i> <span class="ml-1">${
                                appt.time
                              } (${appt.duration || 30} min)</span></p>
                          </div>
                      </div>
                      <button onclick="deleteAppointment('${
                        appt.id
                      }')" class="text-red-400 hover:text-red-600 transition p-2 ml-3 focus:outline-none" title="Delete Appointment">
                          <i class="fas fa-trash-alt text-lg"></i>
                      </button>
                  </div>
              `;
          });
        }

        listHTML += `</div>`;
        container.innerHTML = listHTML;
      }
      window.renderUpcomingView = renderUpcomingView;

      function renderAddAppointmentView() {
        const container = document.getElementById("add-appointment-view");
        if (container.classList.contains("hidden")) return;

        // Set default date to the currently selected date in the calendar
        const defaultDate = formatDate(window.state.selectedDate);
        const nowTime = new Date();
        const defaultTime = `${String(nowTime.getHours()).padStart(
          2,
          "0"
        )}:${String(nowTime.getMinutes()).padStart(2, "0")}`;

        // Generate service options (now checkboxes)
        const serviceOptions = window.state.services
          .map(
            (service) =>
              `<label class="flex items-center space-x-2 p-3 border-b border-gray-100 cursor-pointer hover:bg-indigo-50 transition">
                  <input type="checkbox" name="serviceId" value="${service.id}" data-duration="${service.duration}" 
                         class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" 
                         onchange="updateAppointmentDuration()">
                  <span class="text-gray-800">${service.name}</span>
                  <span class="text-sm text-gray-500 ml-auto">${service.duration} min</span>
              </label>`
          )
          .join("");

        container.innerHTML = `
                <div class="p-4 bg-white rounded-xl shadow-2xl border border-gray-100">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Book New Appointment</h2>
                    <form onsubmit="saveAppointment(event)" id="appointment-form" class="space-y-4">
                        
                        <div>
                            <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Client Name <span class="text-red-500">*</span></label>
                            <input type="text" id="clientName" name="clientName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="e.g., Jane Doe">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Select Services (Multiple allowed) <span class="text-red-500">*</span></label>
                            <div id="service-options-container" class="border border-gray-300 rounded-lg max-h-48 overflow-y-auto bg-white shadow-sm divide-y">
                                ${
                                  window.state.services.length === 0
                                    ? '<p class="p-4 text-gray-500 text-center">No services defined. Please use the **Services** tab to add them first!</p>'
                                    : serviceOptions
                                }
                            </div>
                        </div>

                        <div class="flex space-x-3">
                            <div class="w-1/2">
                                <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date <span class="text-red-500">*</span></label>
                                <input type="date" id="date" name="date" required value="${defaultDate}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm">
                            </div>
                            <div class="w-1/2">
                                <label for="time" class="block text-sm font-medium text-gray-700 mb-1">Time <span class="text-red-500">*</span></label>
                                <input type="time" id="time" name="time" required value="${defaultTime}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm">
                            </div>
                        </div>

                        <div>
                            <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">Total Duration (minutes)</label>
                            <input type="number" id="duration" name="duration" min="5" value="30" readonly 
                                   class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed font-bold text-indigo-600 transition shadow-sm">
                            <p class="text-xs text-gray-500 mt-1">Duration sums up based on the selected services.</p>
                        </div>
                        
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                            <textarea id="notes" name="notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="Details about the client or service."></textarea>
                        </div>

                        <button type="submit" class="w-full py-3 mt-6 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 flex items-center justify-center">
                            <i class="fas fa-calendar-plus mr-2"></i> Save Appointment
                        </button>
                    </form>
                </div>
            `;
        const form = document.getElementById("appointment-form");
        if (form) {
          document.getElementById("clientName").focus();
        }
        // Initialize duration calculation
        updateAppointmentDuration();
      }

      function renderServiceManagementView() {
        const container = document.getElementById("service-management-view");
        if (container.classList.contains("hidden")) return;

        // Get the editing ID from the form's dataset if it exists
        let isEditing = null;
        const existingForm = document.getElementById("service-form");
        if (existingForm) {
          isEditing = existingForm.dataset.editingId;
        }

        const servicesList = window.state.services
          .map(
            (service) => `
                <div class="bg-white p-4 rounded-xl shadow border border-gray-100 flex justify-between items-center mb-3">
                    <div>
                        <p class="text-lg font-semibold text-gray-800">${service.name}</p>
                        <p class="text-sm text-gray-500"><i class="fas fa-stopwatch text-indigo-400 mr-1"></i> ${service.duration} minutes</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editService('${service.id}', '${service.name}', ${service.duration})" class="p-2 text-indigo-500 hover:text-indigo-700 transition" title="Edit Service">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteService('${service.id}', '${service.name}')" class="p-2 text-red-500 hover:text-red-700 transition" title="Delete Service">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `
          )
          .join("");

        container.innerHTML = `
                <div class="p-4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" id="service-form-title">${
                      isEditing ? "Edit Service" : "Add New Service"
                    }</h2>
                    
                    <form onsubmit="saveService(event)" id="service-form" class="space-y-4 bg-white p-5 rounded-xl shadow-lg mb-6 border border-indigo-100" ${
                      isEditing ? `data-editing-id="${isEditing}"` : ""
                    }>
                        
                        <div>
                            <label for="serviceName" class="block text-sm font-medium text-gray-700 mb-1">Service Name <span class="text-red-500">*</span></label>
                            <input type="text" id="serviceName" name="serviceName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="e.g., Gel Manicure">
                        </div>

                        <div>
                            <label for="serviceDuration" class="block text-sm font-medium text-gray-700 mb-1">Duration (minutes) <span class="text-red-500">*</span></label>
                            <input type="number" id="serviceDuration" name="serviceDuration" required min="5" value="30" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm">
                        </div>
                        
                        <button type="submit" id="service-submit-btn" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                            ${isEditing ? "Update Service" : "Save Service"}
                        </button>
                        <button type="button" onclick="cancelEditService()" id="service-cancel-edit" class="w-full py-2 mt-2 text-indigo-600 border border-indigo-600 font-semibold rounded-xl hover:bg-indigo-50 transition ${
                          isEditing ? "" : "hidden"
                        }">
                            Cancel Edit
                        </button>
                    </form>

                    <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">Defined Services (${
                      window.state.services.length
                    })</h3>
                    <div class="service-list-container max-h-[40vh] overflow-y-auto pr-2">
                        ${
                          window.state.services.length === 0
                            ? '<p class="text-gray-500 text-center py-5">No services defined yet. Use the form above to get started!</p>'
                            : servicesList
                        }
                    </div>
                </div>
            `;
        // Manually restore form values after re-rendering if necessary, and ensure correct buttons/titles are shown
        const form = document.getElementById("service-form");
        if (isEditing && window.state.services.length > 0) {
          const serviceToEdit = window.state.services.find(
            (s) => s.id === isEditing
          );
          if (serviceToEdit) {
            form.serviceName.value = serviceToEdit.name;
            form.serviceDuration.value = serviceToEdit.duration;
          }
        }
      }
      window.renderServiceManagementView = renderServiceManagementView;

      // Initialize the app when the window loads
      window.onload = initApp;

      // Start with the initial view set to calendar
      changeView("calendar");
    </script>
  </body>
</html>
